<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>TODO SSE Demo</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; }
    #log { border: 1px solid #ddd; padding: 8px; height: 200px; overflow:auto; background:#f9f9f9; }
    #status { margin-left:8px; font-weight: bold; }
    button { margin-top:8px; }
    .connected { color: green; }
    .disconnected { color: red; }
  </style>
</head>
<body>
  <h2>TODO SSE Demo</h2>
  <div>
    Token: <input id="token" value="demo-token"/>
    <button id="connect">Connect</button>
    <button id="disconnect">Disconnect</button>
    <span id="status" class="disconnected">disconnected</span>
  </div>
  <div id="log"></div>
  <div style="margin-top:12px;">
    <input id="msg" placeholder="message"/>
    <button id="send">Send (GET /notify?msg=)</button>
  </div>

  <script>
    let es;
    const statusEl = document.getElementById('status');
    const log = (s) => {
      const d = document.getElementById('log');
      d.innerHTML = new Date().toLocaleTimeString() + ' — ' + s + '<br/>' + d.innerHTML;
    };
    const setStatus = (connected) => {
      if (connected) {
        statusEl.textContent = 'connected';
        statusEl.classList.remove('disconnected');
        statusEl.classList.add('connected');
      } else {
        statusEl.textContent = 'disconnected';
        statusEl.classList.remove('connected');
        statusEl.classList.add('disconnected');
      }
    };

    document.getElementById('connect').onclick = () => {
      if (es && es.readyState === 1) {
        log('already connected');
        return;
      }
      const token = encodeURIComponent(document.getElementById('token').value || 'demo-token');
      es = new EventSource('/sse?token=' + token);

      // open event (browser-level)
      es.onopen = () => {
        setStatus(true);
        log('EventSource open (connected)');
      };

      // default message (data without explicit event name)
      es.onmessage = e => log('message: ' + e.data);

      // named event 'connected' (server sends event: connected)
      es.addEventListener('connected', e => {
        log('connected event: ' + e.data);
        setStatus(true);
      });

      // example named notification (if server sends event: notification)
      es.addEventListener('notification', e => log('notification: ' + e.data));

      es.onerror = e => {
        // when error happens, EventSource usually transitions to CLOSED or reconnects.
        log('error or closed');
        setStatus(false);
      };

      log('connecting...');
    };

    document.getElementById('disconnect').onclick = () => {
      if (es) { es.close(); setStatus(false); log('closed'); }
    };

    document.getElementById('send').onclick = () => {
      const msg = encodeURIComponent(document.getElementById('msg').value || 'hello');
      fetch('/notify?msg=' + msg).then(()=>log('sent ' + decodeURIComponent(msg)));
    };
  </script>
</body>
</html>